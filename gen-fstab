#!/bin/bash
# jon 2020
# bin/gen-fstab


substructure=$1
found_layout=$(lsblk -ln | grep $substructure | tr -s ' ')

echo "# The following was generated by gen-fstab" > fstab.gen
echo "# Modify or use at your own risk" >> fstab.gen
echo "" >> fstab.gen


IFS=$'\n'

for disk_line in $found_layout
do

	# Could all be done with one sed but am to lazy to rewrite this shit 
	disk_path=/dev/$(echo $disk_line | cut -d ' ' -f1)
	blk_line=$(blkid $disk_path)
	uuid=$(echo $blk_line | cut -d ' ' -f2)
	mount=$(echo $disk_line | cut -d ' ' -f7)
	if [ $mount = $substructure ]
	then
		mpoint=/
		mopts=noatime
		dump=0
		pass=1

	else
		
		mpoint=${mount:$(($(echo $substructure| wc -c) - 1))}
		mopts=defaults
		if [ $mpoint = "/boot" ]
		then
			dump=1
			pass=2
		else
			dump=0
			pass=0
		fi


	fi
	fs_type=$(echo $blk_line | cut -d ' ' -f4 | sed 's/[^"]*"\([^"]*\).*/\1/')


	echo "#$disk_path" >> fstab.gen
	echo "$uuid $mpoint $fs_type $mopts $dump $pass" >> fstab.gen
done

